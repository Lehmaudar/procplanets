<!DOCTYPE html>
<html>
  <head>
    <title>ProcPlanets</title>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0"
    />

    <!-- External libraries from the web -->
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/stats.js/r16/Stats.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r83/three.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dat-gui/0.7.5/dat.gui.min.js"></script>
    <script src="http://wzrd.in/standalone/uuid%2Fv1@latest"></script>
    <script src="http://threejs.org/examples/js/controls/TrackballControls.js"></script> -->

    <!-- External libraries from local machine -->
    <script type="text/javascript" src="js/external/three.r96.js"></script>
    <script type="text/javascript" src="js/external/stats.min.js"></script>
    <script type="text/javascript" src="js/external/dat.gui.min.js"></script>
    <script type="text/javascript" src="js/external/uuid_v1@latest.js"></script>
    <script
      type="text/javascript"
      src="js/external/TrackballControls.js"
    ></script>
    <script type="text/javascript" src="js/external/FlyControls.js"></script>
    <script
      type="text/javascript"
      src="js/external/PointerLockControls.js"
    ></script>
    <script
      type="text/javascript"
      src="js/external/threex.keyboardstate.js"
    ></script>

    <!-- Project js files -->
    <script type="text/javascript" src="js/icosphere.js"></script>

    <style>
      body {
        overflow: hidden;
        padding: 0;
        margin: 0;
        color: #222;
        background-color: #111;
        font-family: arial;
        font-size: 100%;
      }
    </style>
  </head>
  <body>
    <div id="container"></div>
    <script type="text/javascript">
      var scene, renderer, composer, camera, icosphere;
      var stats, gui, cameraControls, keyboard;
      // var variables = datGui();
      var mouseSpeed = 0;
      var clock = new THREE.Clock();
      var keyboard = new THREEx.KeyboardState();

      init();
      var variables = datGui();
      animate();

      // dat.gui ui
      function datGui() {
        var Variables = function() {
          this.spinSpeed = 0.0;
          this.tessConstant = 0.15;
          this.tessGive = 0.01;
          this.tessZoomIn = true;
          this.tessZoomOut = true;
          this.wireframe = false;
          this.addDetail = function() {
            addDetail();
            icosphere.geometry.elementsNeedUpdate = true;
          };
          this.removeDetail = function() {
            removeDetail();
            icosphere.geometry.elementsNeedUpdate = true;
          };
          this.vertexColors = true;
          this.useTreeStruc = true;
          this.customControls = true;
        };

        variables = new Variables();
        gui = new dat.GUI();

        var folder1 = gui.addFolder("Appearance");
        var folder2 = gui.addFolder("Tesselation");
        var folder3 = gui.addFolder("Controls");
        // folder1.open();
        // folder2.open();
        folder3.open();
        folder1.add(variables, "spinSpeed", 0, 2);
        folder2.add(variables, "tessConstant", 0.0005, 0.6);
        folder2.add(variables, "tessGive", 0, 0.1);
        folder2.add(variables, "tessZoomIn");
        folder2.add(variables, "tessZoomOut");
        folder2.add(variables, "useTreeStruc");
        folder2.add(variables, "addDetail");
        folder2.add(variables, "removeDetail");
        var wireframe = folder1.add(variables, "wireframe");
        var vertexColors = folder1.add(variables, "vertexColors");
        wireframe.onChange(function(value) {
          icosphere.material.wireframe = value;
        });
        vertexColors.onChange(function(value) {
          value
            ? (icosphere.material.vertexColors = 1)
            : (icosphere.material.vertexColors = 0);
          icosphere.material.needsUpdate = true;
        });
        var customControls = folder3.add(variables, "customControls");
        trackballControls.enabled = false;
        customControls.onChange(function(value) {
          value;
          if (value) {
            trackballControls.reset();
            mouseSpeed = 0;
            trackballControls.enabled = false;
          } else {
            trackballControls.enabled = true;
          }
        });
        return variables;
      }

      // init the scene
      function init() {
        renderer = new THREE.WebGLRenderer({
          antialias: true
        });
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);

        // window event listeners
        window.addEventListener("wheel", onMouseWheel, false);
        window.addEventListener("resize", onWindowResize, false);

        // add keyboard
        keyboard = new THREEx.KeyboardState(renderer.domElement);
        renderer.domElement.setAttribute("tabIndex", "0");
        renderer.domElement.focus();

        // add Stats.js - https://github.com/mrdoob/stats.js
        stats = new Stats();
        stats.domElement.style.position = "absolute";
        stats.domElement.style.bottom = "0px";
        document.body.appendChild(stats.domElement);

        // create a scene
        scene = new THREE.Scene();

        // put a camera in the scene
        camera = new THREE.PerspectiveCamera(
          35,
          window.innerWidth / window.innerHeight,
          0.00001,
          10000
        );
        camera.position.set(0, 0, 5);
        scene.add(camera);

        // create a camera contol
        trackballControls = new THREE.TrackballControls(
          camera,
          renderer.domElement
        );
        trackballControls.minDistance = 1.01;
        // trackballControls = new THREE.PointerLockControls(camera);
        // trackballControls.lock();
        // scene.add(trackballControls.getObject());

        // create a camera contol
        // cameraControls = new THREE.FlyControls(camera, renderer.domElement);

        // Objects
        icosphere();
        group = new THREE.Object3D(); //create an empty container
        group.add(icosphere); //add a mesh with geometry to it
        scene.add(group); //when done, add the group to the scene
      }

      // let lastTimeMsec

      // animation loop
      function animate() {
        requestAnimationFrame(animate);
        delta = clock.getDelta();

        // update camera controls
        if (!variables.customControls) {
          trackballControls.update();
        } else {
          parseControls(delta);
        }

        // console.log(camera.position);

        // focus on canvas in case gui has been pressed
        renderer.domElement.setAttribute("tabIndex", "0");
        renderer.domElement.focus();

        render();

        stats.update();
      }

      function render() {
        // variable which is increase by Math.PI every seconds - usefull for animation
        var PIseconds = Date.now() * Math.PI;

        if (variables.useTreeStruc) {
          LOD(
            camera.position,
            variables.tessConstant,
            variables.tessGive,
            variables.tessZoomIn,
            variables.tessZoomOut
          );
        } else {
          LODold(
            camera.position,
            variables.tessConstant,
            variables.tessGive,
            variables.tessZoomIn,
            variables.tessZoomOut
          );
        }

        // actually render the scene
        renderer.render(scene, camera);
      }

      function parseControls(delta, now) {
        // exponential = Math.pow(camera.position.z - 1, 2) / 40;
        exponential = Math.pow(camera.position.z - 1, 1.2) / 40;

        if (keyboard.pressed("left")) {
          group.rotateOnWorldAxis(
            new THREE.Vector3(0, 1, 0),
            -10 * delta * exponential
          );
        } else if (keyboard.pressed("right")) {
          group.rotateOnWorldAxis(
            new THREE.Vector3(0, 1, 0),
            10 * delta * exponential
          );
        }
        if (keyboard.pressed("down")) {
          group.rotateOnWorldAxis(
            new THREE.Vector3(1, 0, 0),
            10 * delta * exponential
          );
        } else if (keyboard.pressed("up")) {
          group.rotateOnWorldAxis(
            new THREE.Vector3(1, 0, 0),
            -10 * delta * exponential
          );
        }

        camera.position.z -= mouseSpeed * delta * exponential * 2;

        if (camera.position.z < 1.001) camera.position.z = 1.001;
        else if (camera.position.z > 60) camera.position.z = 60;
        if (mouseSpeed < -0.1) mouseSpeed += 0.1;
        else if (mouseSpeed > 0.1) mouseSpeed -= 0.1;
        else mouseSpeed = 0;
      }

      function onMouseWheel(event) {
        event.preventDefault();
        const mouseDelta = -event.deltaY / 150;
        // console.log(mouseDelta);
        if (
          (mouseDelta > 0 && mouseSpeed < 0) ||
          (mouseDelta < 0 && mouseSpeed > 0)
        ) {
          mouseSpeed = 0;
        }
        mouseSpeed += mouseDelta;
      }

      function onWindowResize() {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
      }
    </script>
  </body>
</html>
